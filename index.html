<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Milestones (Supabase Auto-Save)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">ðŸ“Œ Project Milestones</h1>



    <!-- Project Selector -->
    <div class="mb-6 flex items-center gap-3">
      <select id="projectSelect" class="p-2 border rounded bg-white"></select>
      <input id="newProjectName" placeholder="New project name" class="p-2 border rounded">
      <button onclick="addProject()" class="px-3 py-2 bg-black text-white rounded">+ Add Project</button>
    </div>

    <!-- Milestones List -->
    <div id="milestones" class="space-y-3"></div>

    <!-- Add Milestone -->
    <div class="mt-6 flex gap-3">
      <input id="newMilestone" placeholder="New milestone" class="flex-1 p-2 border rounded">
      <button onclick="addMilestone()" class="px-4 py-2 bg-black text-white rounded">+ Add</button>
    </div>
  </div>

  <script>
    // ðŸ”‘ Replace with your Supabase credentials
    const SUPABASE_URL = "https://zzjxxqkttaqubotwnolj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6anh4cWt0dGFxdWJvdHdub2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MDI2MTIsImV4cCI6MjA3MjQ3ODYxMn0.YlFG4Ae9P7lzggtmFMLpNjtFFGeYqpZt5ngEYv7UMsM";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentProject = null;
    let milestonesCache = [];  // local cache of milestones
    let dirty = false;         // tracks unsaved changes

    const projectSelect = document.getElementById("projectSelect");
    const milestonesDiv = document.getElementById("milestones");

    // ðŸ“Œ Load all projects
    async function loadProjects() {
      const { data, error } = await supabaseClient
        .from("milestones")
        .select("project");

      if (error) { console.error(error); return; }

      const projects = [...new Set(data.map(m => m.project))];
      projectSelect.innerHTML = "";
      projects.forEach(p => {
        let opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        projectSelect.appendChild(opt);
      });

      if (!currentProject && projects.length > 0) {
        currentProject = projects[0];
      }
      if (currentProject) projectSelect.value = currentProject;

      renderMilestones();
    }

async function addProject() {
  const name = document.getElementById("newProjectName").value.trim();
  if (!name) return;

  // Insert a dummy milestone so project exists in DB
  const { error } = await supabaseClient
    .from("milestones")
    .insert([{ project: name, text: "New project created", completed: false }]);

  if (error) {
    console.error("Error creating project:", error);
    return;
  }

  currentProject = name;
  document.getElementById("newProjectName").value = "";
  await loadProjects();
}


    projectSelect.addEventListener("change", e => {
      currentProject = e.target.value;
      renderMilestones();
    });

    // ðŸ“Œ Load milestones
    async function fetchMilestones() {
      if (!currentProject) return [];
      const { data, error } = await supabaseClient
        .from("milestones")
        .select("*")
        .eq("project", currentProject);

      if (error) { console.error(error); return []; }
      milestonesCache = data;
      return milestonesCache;
    }

    // ðŸ“Œ Add milestone (save immediately)
    async function addMilestone(parentId = null) {
      const input = document.getElementById("newMilestone");
      const text = input.value.trim();
      if (!text || !currentProject) return;

      const { data, error } = await supabaseClient
        .from("milestones")
        .insert([{ project: currentProject, text, parent_id: parentId, completed: false }])
        .select();

      if (!error && data.length > 0) {
        milestonesCache.push(data[0]);
        renderMilestones();
      }
      input.value = "";
    }

    // ðŸ“Œ Update milestone locally (auto-saved later)
    function updateLocal(id, updates) {
      let m = milestonesCache.find(x => x.id === id);
      if (m) {
        Object.assign(m, updates);
        dirty = true; // mark unsaved
      }
    }

    // ðŸ“Œ Save immediately (for critical actions)
    async function saveNow(id, updates) {
      const { error } = await supabaseClient
        .from("milestones")
        .update(updates)
        .eq("id", id);
      if (error) console.error(error);
    }

    // ðŸ“Œ Delete milestone (immediate)
    async function deleteMilestone(id) {
      if (!confirm("Delete this milestone (and its sub-milestones)?")) return;
      const { error } = await supabaseClient
        .from("milestones")
        .delete()
        .eq("id", id);

      if (error) console.error(error);
      else {
        milestonesCache = milestonesCache.filter(m => m.id !== id && m.parent_id !== id);
        renderMilestones();
      }
    }

setInterval(async () => {
  if (dirty) {
    const statusEl = document.getElementById("saveStatus");
    statusEl.textContent = "ðŸ’¾ Saving...";
    statusEl.className = "text-sm text-blue-500 mb-4";

    for (let m of milestonesCache) {
      const { error } = await supabaseClient
        .from("milestones")
        .update({
          text: m.text,
          notes: m.notes,
          target_date: m.target_date,
          completed: m.completed,
          completed_date: m.completed_date
        })
        .eq("id", m.id);
      if (error) console.error(error);
    }

    dirty = false;

    // Show success
    statusEl.textContent = "âœ… All changes saved";
    statusEl.className = "text-sm text-green-600 mb-4";

    // Fade out after 2 seconds
    setTimeout(() => {
      statusEl.textContent = "";
    }, 2000);
  }
}, 5000);


    // ðŸ“Œ Render milestones
    async function renderMilestones() {
      await fetchMilestones();
      milestonesDiv.innerHTML = "";

      function buildTree(items, parentId = null) {
        return items.filter(m => m.parent_id === parentId)
                    .map(m => ({ ...m, children: buildTree(items, m.id) }));
      }

      const tree = buildTree(milestonesCache);

      function createList(items, parentEl) {
        items.forEach(m => {
          let row = document.createElement("div");
          row.className = "bg-white p-3 rounded shadow";
          row.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <input type="checkbox" ${m.completed ? "checked" : ""} class="mr-2">
                <span class="${m.completed ? 'line-through text-gray-500' : ''}">${m.text}</span>
                ${m.completed && m.completed_date ? `<span class="text-xs text-green-600 ml-2">(âœ” ${m.completed_date})</span>` : ""}
              </div>
              <div class="flex gap-2">
                <button class="text-sm px-2 py-1 bg-gray-200 rounded">+ Sub</button>
                <button class="text-sm px-2 py-1 bg-red-500 text-white rounded">ðŸ—‘ Delete</button>
              </div>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <label class="text-xs text-gray-600">ðŸŽ¯ Target:</label>
              <input type="date" value="${m.target_date || ""}" class="p-1 border rounded text-sm">
            </div>
            <textarea placeholder="Notes/updates..."
                      class="w-full mt-2 p-2 border rounded text-sm">${m.notes || ""}</textarea>
            <div class="ml-6 mt-2 space-y-2"></div>
          `;

          // âœ… Critical: Save immediately
          row.querySelector("input[type=checkbox]").addEventListener("change", e => {
            updateLocal(m.id, { 
              completed: e.target.checked,
              completed_date: e.target.checked ? new Date().toISOString().split("T")[0] : null
            });
            saveNow(m.id, { completed: e.target.checked, completed_date: e.target.checked ? new Date().toISOString().split("T")[0] : null });
            renderMilestones();
          });

          row.querySelector("button.bg-gray-200").addEventListener("click", () => {
            let subName = prompt("Enter sub-milestone:");
            if (subName) addMilestone(m.id, subName);
          });

          row.querySelector("button.bg-red-500").addEventListener("click", () => {
            deleteMilestone(m.id);
          });

          // ðŸ“ Non-critical: update locally only, auto-saved later
          row.querySelector("input[type=date]").addEventListener("change", e => {
            updateLocal(m.id, { target_date: e.target.value });
          });

          row.querySelector("textarea").addEventListener("input", e => {
            updateLocal(m.id, { notes: e.target.value });
          });

          let childContainer = row.querySelector("div.ml-6");
          createList(m.children, childContainer);

          parentEl.appendChild(row);
        });
      }

      createList(tree, milestonesDiv);
    }

    // Initial load
    loadProjects();
  </script>
      <div id="saveStatus" class="text-sm text-gray-500 mb-4"></div>
</body>
</html>



